#!/usr/bin/env bash
# tools/collect.sh  â€”â€” ä¸€é”®æ•´åˆæ•´ä¸ªä»»åŠ¡çš„å…³é”®é…ç½®ä¸è¾“å‡º

set -euo pipefail

WORKDIR="$(cd "$(dirname "$0")/.." && pwd)"
NODE1_OUT="$WORKDIR/node1"
NODE3_OUT="$WORKDIR/node3"

echo "å¼€å§‹æ”¶é›†..."

# === 1) node1 æ”¶é›† ===

echo "æ”¶é›† node1 è„šæœ¬ã€cronã€fstab ç›¸å…³å†…å®¹"

mkdir -p "$NODE1_OUT/scripts" "$NODE1_OUT/cron" "$NODE1_OUT/storage"

# æ‹·è´åŒæ­¥è„šæœ¬
cp -a /usr/local/sbin/zzyl_log_sync.sh "$NODE1_OUT/scripts/zzyl_log_sync.sh" || true

# å¯¼å‡º root çš„ crontab
crontab -l > "$NODE1_OUT/cron/crontab.root" || true

# æˆªå– fstab ä¸­æœ‰å…³ zzyl_logs çš„é‚£ä¸€è¡Œ
grep -n "zzyl_logs" /etc/fstab > "$NODE1_OUT/storage/fstab.zzyl_logs.addition" || true

# æŒ‚è½½éªŒè¯è¾“å‡º
lsblk > "$NODE1_OUT/storage/lsblk.txt"
df -hT /mnt/zzyl_logs > "$NODE1_OUT/storage/df_zzyl_logs.txt"

# === 2) node3 æ”¶é›† ===

echo "æ”¶é›† node3 logrotate é…ç½®"

mkdir -p "$NODE3_OUT/logrotate"

# æ‹·è´ nginx logrotate é…ç½®
scp root@192.168.88.103:/etc/logrotate.d/nginx "$NODE3_OUT/logrotate/nginx" || true

echo "æ”¶é›†å®Œæˆ ğŸ‰"
echo "æ‰€æœ‰æ–‡ä»¶å·²æ•´ç†åˆ° $WORKDIR"

